@page "/resources/form/"
@page "/resources/form/{id:guid}"
@using System.Text.Json
@using WarehouseManagement.Contracts.Models.WarehouseResource
@using WarehouseManagement.Domain
@using WarehouseManagement.Frontend.Services
@inject HttpClient Http
@inject NavigationManager Navigation
@inject ILogger<ResourceForm> Logger
@inject INotificationManager NotificationManager

<PageTitle>@(IsNew ? "Новый ресурс" : "Ресурс")</PageTitle>

<h1>@(IsNew ? "Новый ресурс" : "Ресурс")</h1>

@if (isLoading)
{
    <p><em>Загрузка...</em></p>
}
else
{
    <EditForm Model="@resourceModel" OnValidSubmit="HandleValidSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label for="name" class="form-label">Наименование:</label>
            <InputText id="name" class="form-control" @bind-Value="resourceModel.Name" />
            <ValidationMessage For="@(() => resourceModel.Name)" />
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger" role="alert">
                @errorMessage
            </div>
        }

        <button type="submit" class="btn btn-primary me-2">Сохранить</button>

        @if (!IsNew)
        {
            <button type="button" class="btn @(resourceModel.State == WorkingState.Archived ? "btn-success" : "btn-warning") me-2" @onclick="ToggleState">
                @(resourceModel.State == WorkingState.Archived ? "В работу" : "В архив")
            </button>
            <button type="button" class="btn btn-danger" @onclick="Delete">Удалить</button>
        }
        <button type="button" class="btn btn-secondary ms-2" @onclick="GoBack">Назад</button>
    </EditForm>
}

@code {
    [Parameter] public Guid? Id { get; set; }

    private bool IsNew => !Id.HasValue;
    private WarehouseResource resourceModel;
    private string errorMessage = string.Empty;
    private bool isLoading = true;
    private WorkingState originalState = WorkingState.Working; // Чтобы знать, куда возвращаться

    protected override async Task OnParametersSetAsync()
    {
        // Сброс состояния при изменении параметра
        resourceModel = new WarehouseResource { Id = Id ?? Guid.Empty, Name = string.Empty, State = WorkingState.Working };
        errorMessage = string.Empty;
        isLoading = true;
        originalState = WorkingState.Working;

        if (!IsNew)
        {
            try
            {
                var resourceDto = await Http.GetFromJsonAsync<WarehouseResourceDto>($"api/resources/get/{Id.Value}");
                if (resourceDto != null)
                {
                    resourceModel.Name = resourceDto.Name;
                    resourceModel.State = resourceDto.State;
                    originalState = resourceDto.State;
                }
                else
                {
                    errorMessage = "Ресурс не найден.";
                }
            }
            catch (Exception ex)
            {
                Logger.LogError("Ошибка загрузки ресурса: {Exception}", ex);
                errorMessage = "Ошибка при загрузке данных ресурса.";
            }
        }
        else
        {
            resourceModel.State = WorkingState.Working;
            originalState = WorkingState.Working;
        }
        isLoading = false;
    }
      
    private async Task HandleValidSubmit()
    {
        errorMessage = string.Empty;
        try
        {
            HttpResponseMessage response;
            if (IsNew)
            {
                if (IsEmpty(resourceModel.Name))
                {
                    NotificationManager.ShowError("Ошибка", "Наименование не должно быть пустым");
                    return;
                }
                var createDto = new CreateResourceDto { Name = resourceModel.Name, State = resourceModel.State };
                response = await Http.PostAsJsonAsync("api/resources/add", createDto);
            }
            else if (Id.HasValue)
            {
                if (IsEmpty(resourceModel.Name))
                {
                    NotificationManager.ShowError("Ошибка", "Наименование не должно быть пустым");
                    return;
                }
                var updateDto = new UpdateResourceDto { Id = Id.Value, Name = resourceModel.Name, State = null };
                response = await Http.PatchAsJsonAsync($"api/resources/update/{Id.Value}", updateDto);
            }
            else
            {
                errorMessage = "Неверное состояние формы.";
                NotificationManager.ShowError("Ошибка", errorMessage); // Уведомление об ошибке
                return;
            }

            if (response.IsSuccessStatusCode)
            {
                NotificationManager.ShowSuccess("Успех", IsNew ? "Ресурс создан успешно!" : "Ресурс обновлён успешно!"); // Уведомление об успехе
                GoBack();
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                var apiErrorMessage = GetMessageFromApiError(errorContent);
                errorMessage = $"Ошибка API: {response.StatusCode} - {apiErrorMessage}";
                NotificationManager.ShowError("Ошибка API", errorMessage); // Уведомление об ошибке API
            }
        }
        catch (HttpRequestException httpEx)
        {
            Logger.LogError($"Ошибка HTTP при сохранении ресурса: {httpEx}");
            errorMessage = $"Ошибка сети: {httpEx.Message}";
            NotificationManager.ShowError("Ошибка сети", errorMessage); // Уведомление об ошибке сети
        }
        catch (Exception ex)
        {
            Logger.LogError($"Ошибка сохранения ресурса: {ex}");
            errorMessage = "Произошла ошибка при сохранении.";
            NotificationManager.ShowError("Ошибка", errorMessage); // Уведомление об общей ошибке
        }
    }

    private async Task ToggleState()
    {
        if (!Id.HasValue) return;
        try
        {
            var newState = resourceModel.State == WorkingState.Archived ? WorkingState.Working : WorkingState.Archived;
            var updateDto = new UpdateResourceDto { Id = Id.Value, Name = null, State = newState };
            var response = await Http.PatchAsJsonAsync($"api/resources/update/{Id.Value}", updateDto);

            if (response.IsSuccessStatusCode)
            {
                resourceModel.State = newState;
                originalState = newState;
                Logger.LogInformation($"Состояние ресурса изменено на {newState}.");
                NotificationManager.ShowSuccess("Успех", $"Состояние ресурса изменено на {(newState == WorkingState.Working ? "Рабочий" : "Архивный")}.");
                StateHasChanged();
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                var apiErrorMessage = GetMessageFromApiError(errorContent);
                errorMessage = $"Ошибка изменения состояния: {response.StatusCode} - {apiErrorMessage}";
                NotificationManager.ShowError("Ошибка", errorMessage); // Уведомление об ошибке изменения состояния
            }
        }
        catch (Exception ex)
        {
            Logger.LogError($"Ошибка изменения состояния ресурса: {ex}");
            errorMessage = "Ошибка при изменении состояния ресурса.";
            NotificationManager.ShowError("Ошибка", errorMessage); // Уведомление об ошибке
        }
    }

    private async Task Delete()
    {
        if (!Id.HasValue) return;
        try
        {
            var response = await Http.DeleteAsync($"api/resources/delete/{Id.Value}");
            if (response.IsSuccessStatusCode)
            {
                Logger.LogInformation("Ресурс удалён.");
                NotificationManager.ShowSuccess("Успех", "Ресурс успешно удалён.");
                GoBack();
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                var apiErrorMessage = GetMessageFromApiError(errorContent);
                errorMessage = $"Ошибка удаления: {response.StatusCode} - {apiErrorMessage}";
                NotificationManager.ShowError("Ошибка", errorMessage); // Уведомление об ошибке удаления
            }
        }
        catch (Exception ex)
        {
            Logger.LogError($"Ошибка удаления ресурса: {ex}");
            errorMessage = "Ошибка при удалении ресурса.";
            NotificationManager.ShowError("Ошибка", errorMessage); // Уведомление об ошибке
        }
    }

    private void GoBack()
    {
        // Определяем, на какую страницу ресурсов возвращаться, основываясь на исходном состоянии ресурса
        var backStateSegment = originalState == WorkingState.Archived ? "archived" : "working";
        Navigation.NavigateTo($"/resources/{backStateSegment}");
    }

    private string GetMessageFromApiError(string errorContent)
    {
        string apiErrorMessage = errorContent; // Сообщение по умолчанию

        try
        {
            // Пытаемся распарсить JSON из тела ответа
            using var document = JsonDocument.Parse(errorContent);
            var root = document.RootElement;

            // Проверяем, есть ли свойство "message"
            if (root.TryGetProperty("message", out var messageElement))
            {
                apiErrorMessage = messageElement.GetString() ?? apiErrorMessage;
            }
        }
        catch (JsonException ex)
        {
            Logger.LogError("Ошибка при парсинге JSON ошибки: {ExMessage}. Исходная ошибка: {ErrorContent}", ex.Message, errorContent);
        }

        return apiErrorMessage;
    }

    private bool IsEmpty(string s)
    {
        return s.Trim().Length == 0;
    }
}